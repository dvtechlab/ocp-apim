include charts/wso2-am/Makefile
include charts/ob-uk/Makefile

-include keystores/Makefile

ENVIRONMENT=dev

OB_UK_CHART_PATH=charts/ob-uk
PG_TPP_CHART_PATH=charts/pg-tpp

BASE_PATH=keystores

install-all: install-pre-installations \
	install-apps

# ======================================================================================================================
# Pre installation commands

install-secrets-store-provider:
	helm upgrade --install csi csi-secrets-store-provider-azure \
		--repo https://azure.github.io/secrets-store-csi-driver-provider-azure/charts \
		--set secrets-store-csi-driver.syncSecret.enabled=true \
		--namespace kube-system

install-ingress-ctrl:
	helm upgrade --install ingress-nginx ingress-nginx \
		--repo https://kubernetes.github.io/ingress-nginx \
		--set controller.service.externalTrafficPolicy=Local \
		--create-namespace \
        --namespace ingress-ctrl

install-pre-installations: install-secrets-store-provider \
	install-ingress-ctrl

# ======================================================================================================================
# Core commands

install-apps: create-ob-uk-am-secrets \
	create-ob-uk-iam-secrets \
	install-ob-uk-app \
	install-pg-tpp-app

# ======================================================================================================================
# Monitoring commands

# ======================================================================================================================
# Clean up commands

uninstall-secrets-store-provider:
	- helm uninstall csi --namespace kube-system

uninstall-ingress-ctrl:
	- helm uninstall ingress-nginx --namespace ingress-ctrl
	- kubectl delete ns ingress-ctrl

clean-without-pre-installations: uninstall-pg-tpp-app \
	delete-ob-uk-am-secrets \
	delete-ob-uk-iam-secrets \
	uninstall-ob-uk-app

clean-all: clean-without-pre-installations \
	uninstall-secrets-store-provider \
	uninstall-ingress-ctrl

# ======================================================================================================================

-include overrides.mk